<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>질문 게시판</title>
  <style>
    :root{--bg:#0b1220;--panel:#111a2b;--muted:#2e3a55;--text:#e8eefc;--accent:#7aa2ff;--ok:#52d273;--danger:#ff6b6b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0b1220,#0e1830);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .wrap{max-width:880px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 16px}
    .title{font-size:22px;font-weight:700}
    .card{background:var(--panel);border:1px solid #1b2843;border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:#a9b6d9;margin:8px 2px 6px}
    input,textarea{width:100%;box-sizing:border-box;background:#0f1730;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:10px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;background:var(--accent);color:#fff;font-weight:600}
    .ghost{background:#1b2744}
    .danger{background:var(--danger)}
    .list{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .item{background:#0f1730;border:1px solid #1b2843;border-radius:12px;padding:12px}
    .item .top{display:flex;justify-content:space-between;gap:8px}
    .muted{color:#a9b6d9}
    .row{display:flex;gap:8px;align-items:center}
    .search{display:flex;gap:8px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">질문 게시판</div>
    <div class="row">
      <input id="q" placeholder="검색(제목/내용)" />
      <button id="refreshBtn" class="ghost" type="button">새로고침</button>
    </div>
  </header>

  <!-- 작성 폼 -->
  <section class="card">
    <h3 style="margin:0 0 6px">질문 작성</h3>
    <label>제목 *</label>
    <input id="subject" placeholder="예: Alembic 마이그레이션이 뭐죠?" />
    <label>내용 *</label>
    <textarea id="content" placeholder="상세 내용을 입력해주세요."></textarea>
    <div class="actions">
      <button id="resetBtn" class="ghost" type="button">초기화</button>
      <button id="createBtn" type="button">등록</button>
    </div>
    <div id="msg" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- 목록 -->
  <section class="card" style="margin-top:14px">
    <h3 style="margin:0 0 6px">질문 목록</h3>
    <div id="list" class="list"></div>
  </section>
</div>

<script>
const API = {
  list:  "/api/questions",
  create:"/api/questions",
  get:   (id)=>`/api/questions/${id}`,
};

// 공통 fetch
async function request(url, { method="GET", json } = {}) {
  const opts = { method, headers:{} };
  if (json && method !== "GET") {
    opts.headers["Content-Type"]="application/json";
    opts.body = JSON.stringify(json);
  }
  const res = await fetch(url, opts);
  let data = null;
  try { data = await res.json(); } catch { /* noop */ }
  if (!res.ok) {
    const msg = data?.detail || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

async function apiList(){ return await request(API.list); }
async function apiCreate(p){ return await request(API.create, {method:"POST", json:p}); }
async function apiGet(id){ return await request(API.get(id)); }

const $ = (id)=>document.getElementById(id);
const qEl=$("q"), refreshBtn=$("refreshBtn"), subjectEl=$("subject"), contentEl=$("content"), createBtn=$("createBtn"), resetBtn=$("resetBtn"), listEl=$("list"), msg=$("msg");

function itemCard(x){
  const el = document.createElement("div");
  el.className = "item";
  el.innerHTML = `
    <div class="top">
      <div><b>#${x.id}</b> ${x.subject}</div>
      <div class="muted">${new Date(x.create_date).toLocaleString()}</div>
    </div>
    <div class="muted" style="margin-top:6px">${x.content}</div>
    <div class="actions" style="justify-content:flex-start;margin-top:10px">
      <button class="ghost" data-id="${x.id}">상세</button>
    </div>
  `;
  el.querySelector("button").onclick = async () => {
    try{
      const d = await apiGet(x.id);
      alert(`상세보기\n\n제목: ${d.subject}\n작성일: ${new Date(d.create_date).toLocaleString()}\n\n내용:\n${d.content}`);
    }catch(e){ alert("조회 실패: "+e.message); }
  };
  return el;
}

function render(list){
  const q = (qEl.value||"").toLowerCase();
  const filtered = list.filter(x =>
    !q || x.subject.toLowerCase().includes(q) || x.content.toLowerCase().includes(q)
  );
  listEl.innerHTML = "";
  filtered.forEach(x => listEl.appendChild(itemCard(x)));
}

async function refresh(){
  try{
    const data = await apiList();
    render(data);
  }catch(e){
    listEl.innerHTML = `<div class="muted">목록 실패: ${e.message}</div>`;
  }
}

async function onCreate(){
  msg.textContent = "";
  const subject = subjectEl.value.trim();
  const content = contentEl.value.trim();
  if(!subject || !content){
    msg.textContent = "제목과 내용을 입력하세요.";
    return;
  }
  try{
    await apiCreate({subject, content});
    msg.textContent = "등록됨";
    subjectEl.value = ""; contentEl.value = "";
    refresh();
  }catch(e){
    msg.textContent = "등록 실패: " + e.message;
  }
}

createBtn.onclick = onCreate;
resetBtn.onclick  = ()=>{ subjectEl.value=""; contentEl.value=""; msg.textContent=""; };
refreshBtn.onclick= refresh;
qEl.oninput = refresh;

refresh();
</script>
</body>
</html>
