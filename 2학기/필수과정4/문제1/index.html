<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>팀 TO-DO 보드</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111a2b; --muted:#2e3a55; --text:#e8eefc; --sub:#a9b6d9; --accent:#7aa2ff; --ok:#52d273; --warn:#f7b955;
  }
  html,body{height:100%}
  body{margin:0; background:linear-gradient(120deg,#0b1220,#0e1830); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:960px; margin:24px auto; padding:0 16px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin:8px 0 16px}
  .title{font-size:22px; font-weight:700; letter-spacing:.2px}
  .row{display:flex; gap:12px; align-items:stretch}
  .col{flex:1}
  .card{background:var(--panel); border:1px solid #1b2843; border-radius:14px; padding:14px}
  .card h2{margin:0 0 10px; font-size:16px}
  label{display:block; font-size:12px; color:var(--sub); margin:8px 2px 6px}
  input,select,textarea{width:100%; box-sizing:border-box; background:#0f1730; color:var(--text); border:1px solid var(--muted); border-radius:10px; padding:10px; outline:none}
  textarea{min-height:72px; resize:vertical}
  .actions{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px}
  button{border:0; border-radius:12px; padding:10px 14px; cursor:pointer; background:var(--accent); color:#fff; font-weight:600}
  .ghost{background:#1b2744}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #26375c; color:var(--sub)}
  .list{display:grid; grid-template-columns:1fr; gap:10px}
  .item{background:#0f1730; border:1px solid #1b2843; border-radius:12px; padding:12px}
  .item .top{display:flex; justify-content:space-between; gap:8px}
  .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .muted{color:var(--sub)}
  .pri-P1{border-color:#ff8b8b; color:#ff8b8b}
  .pri-P2{border-color:#f7b955; color:#f7b955}
  .pri-P3{border-color:#7aa2ff; color:#7aa2ff}
  .status{padding:4px 8px; border-radius:8px; font-size:12px; border:1px solid #28416d}
  .ok{color:var(--ok); border-color:#2d6b4a}
  .warn{color:var(--warn); border-color:#6b542d}
  .bar{display:flex; justify-content:space-between; align-items:center; gap:12px; margin:8px 0 14px}
  .search{flex:1; display:flex; gap:8px}
  .search input{height:38px}
  .help{font-size:12px; color:var(--sub)}
  .error{margin-top:6px; color:#ff8b8b; font-size:12px}
  .success{margin-top:6px; color:var(--ok); font-size:12px}
  @media (min-width:860px){
    .grid{display:grid; grid-template-columns:380px 1fr; gap:16px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">팀 TO-DO 보드</div>
    <div class="badge" id="countBadge">총 0건</div>
  </header>

  <div class="grid">
    <!-- 입력 패널 -->
    <section class="card">
      <h2>할 일 추가</h2>

      <label>제목 *</label>
      <input id="title" placeholder="예: 디자인 검토 회의 준비">

      <div class="row">
        <div class="col">
          <label>담당자</label>
          <input id="assignee" placeholder="예: minji">
        </div>
        <div class="col">
          <label>기한</label>
          <input id="due" type="date">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>우선순위</label>
          <select id="priority">
            <option value="P2" selected>P2 보통</option>
            <option value="P1">P1 긴급</option>
            <option value="P3">P3 낮음</option>
          </select>
        </div>
        <div class="col">
          <label>상태</label>
          <select id="status">
            <option value="todo" selected>할 일</option>
            <option value="doing">진행중</option>
            <option value="done">완료</option>
          </select>
        </div>
      </div>

      <label>메모</label>
      <textarea id="notes" placeholder="세부 내용"></textarea>

      <div class="actions">
        <button class="ghost" id="resetBtn" type="button">초기화</button>
        <button id="addBtn" type="button">추가</button>
      </div>
      <div id="addMsg" class="help"></div>
      <div class="help">비어있는 객체 전송 시 서버가 400과 경고를 준다. 최소 제목을 입력하라.</div>
    </section>

    <!-- 목록 패널 -->
    <section class="card">
      <div class="bar">
        <h2 style="margin:0">공유 목록</h2>
        <div class="search">
          <input id="q" placeholder="제목 또는 담당자 검색">
          <button id="refreshBtn" class="ghost" type="button">새로고침</button>
        </div>
      </div>
      <div class="list" id="list"></div>
      <div class="help" id="rawHint" style="margin-top:8px"></div>
    </section>
  </div>
</div>

<script>
/* --------- 환경 --------- */
// 같은 기기에서: uvicorn은 8000, 정적 페이지는 5500 같은 포트로 띄우는 경우가 많다.
// 다른 포트면 절대경로(BASE) 사용. 동일 포트/프록시라면 빈 문자열로 두고 상대경로 사용 가능.
const BASE = "http://127.0.0.1:8000"; // 필요 시 변경
const ADD_URL = `${BASE}/todo/add`;
const LIST_URL = `${BASE}/todo/list`;

/* --------- 엘리먼트 --------- */
const $ = (id) => document.getElementById(id);
const titleEl = $("title");
const assigneeEl = $("assignee");
const dueEl = $("due");
const priorityEl = $("priority");
const statusEl = $("status");
const notesEl = $("notes");
const addBtn = $("addBtn");
const resetBtn = $("resetBtn");
const addMsg = $("addMsg");
const listEl = $("list");
const countBadge = $("countBadge");
const refreshBtn = $("refreshBtn");
const qEl = $("q");

/* --------- 유틸 --------- */
function badge(text, cls="badge"){ const s=document.createElement("span"); s.className=cls; s.textContent=text; return s; }
function fmtDate(s){ if(!s) return "기한 미정"; try { const d=new Date(s+"T00:00:00"); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` } catch{ return s } }
function priorityClass(p){ return `badge pri-${p||"P2"}` }

/* --------- API --------- */
async function apiAdd(payload){
  const res = await fetch(ADD_URL, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    const msg = data?.detail?.warning || data?.detail || "추가 실패";
    throw new Error(typeof msg === "string" ? msg : JSON.stringify(msg));
  }
  return data;
}

async function apiList(){
  const res = await fetch(LIST_URL);
  const data = await res.json();
  return data?.todo_list || [];
}

/* --------- 렌더 --------- */
function renderList(items){
  const q = qEl.value.trim().toLowerCase();
  const filtered = items.filter(x=>{
    const t=(x.title||"").toLowerCase();
    const a=(x.assignee||"").toLowerCase();
    return !q || t.includes(q) || a.includes(q);
  });

  listEl.innerHTML = "";
  filtered.forEach((x, idx)=>{
    const it = document.createElement("div");
    it.className = "item";
    const top = document.createElement("div");
    top.className = "top";

    const left = document.createElement("div");
    left.innerHTML = `<div style="font-weight:700">${x.title||"(제목 없음)"}</div>
                      <div class="muted">${x.assignee||"담당자 미정"}</div>`;
    const right = document.createElement("div");
    right.style.textAlign = "right";
    right.appendChild(badge(x.priority||"P2", priorityClass(x.priority)));
    right.appendChild(document.createTextNode(" "));
    const st = badge(x.status||"todo","status " + (x.status==="done"?"ok":x.status==="doing"?"":"warn"));
    right.appendChild(st);

    top.appendChild(left); top.appendChild(right);
    it.appendChild(top);

    const meta = document.createElement("div"); meta.className="meta";
    meta.appendChild(badge("기한: "+fmtDate(x.due)));
    if(x.notes){ meta.appendChild(badge("메모 있음")); }
    meta.appendChild(badge("#"+(idx+1)));
    it.appendChild(meta);

    if(x.notes){
      const notes = document.createElement("div");
      notes.className="muted";
      notes.style.marginTop="6px";
      notes.textContent = x.notes;
      it.appendChild(notes);
    }

    listEl.appendChild(it);
  });

  countBadge.textContent = `총 ${items.length}건`;
  $("rawHint").textContent = filtered.length !== items.length
    ? `필터 적용됨: ${filtered.length}/${items.length}`
    : "";
}

/* --------- 핸들러 --------- */
async function onAdd(){
  addMsg.className = "help";
  addMsg.textContent = "";

  // 빈 Dict 방지: 최소 title만 넣는다. 비면 서버 경고로 400이 온다.
  const payload = {};
  const title = titleEl.value.trim();
  if(title) payload.title = title;
  const assignee = assigneeEl.value.trim();
  if(assignee) payload.assignee = assignee;
  if(dueEl.value) payload.due = dueEl.value;
  if(priorityEl.value) payload.priority = priorityEl.value;
  if(statusEl.value) payload.status = statusEl.value;
  const notes = notesEl.value.trim();
  if(notes) payload.notes = notes;

  try{
    const data = await apiAdd(payload);
    addMsg.className = "success";
    addMsg.textContent = "추가됨: " + (data?.added?.title || "항목");
    await refresh();
    resetForm(true);
  }catch(e){
    addMsg.className = "error";
    addMsg.textContent = "추가 실패: " + e.message;
  }
}

async function refresh(){
  try{
    const list = await apiList();
    renderList(list);
  }catch(e){
    listEl.innerHTML = `<div class="error">목록 로드 실패: ${e.message}</div>`;
  }
}

function resetForm(clearAll=false){
  if(clearAll){
    titleEl.value = "";
    assigneeEl.value = "";
    dueEl.value = "";
    priorityEl.value = "P2";
    statusEl.value = "todo";
    notesEl.value = "";
  }else{
    titleEl.value = "";
    notesEl.value = "";
  }
}

/* --------- 바인딩 --------- */
addBtn.addEventListener("click", onAdd);
resetBtn.addEventListener("click", ()=>resetForm(true));
refreshBtn.addEventListener("click", refresh);
qEl.addEventListener("input", refresh);

/* --------- 초기 로드 --------- */
refresh();
</script>
</body>
</html>
